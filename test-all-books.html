<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test TOUS les Livres Breslov - Sefaria API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .book-test {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .book-test.testing {
            border-color: #ffa500;
            background: #fff9e6;
        }

        .book-test.success {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .book-test.error {
            border-color: #f44336;
            background: #ffebee;
        }

        .book-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
        }

        .status {
            font-size: 0.9em;
            margin: 5px 0;
        }

        .status-icon {
            display: inline-block;
            margin-right: 5px;
        }

        .details {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            font-size: 0.85em;
            font-family: 'Courier New', monospace;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .summary {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
        }

        .stat.success { background: #4caf50; color: white; }
        .stat.error { background: #f44336; color: white; }
        .stat.warning { background: #ffa500; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test de TOUS les Livres Breslov</h1>

        <div class="summary" id="summary" style="display: none;">
            <h2>R√©sum√© des Tests</h2>
            <div class="stats">
                <div class="stat success">‚úÖ <span id="successCount">0</span> Succ√®s</div>
                <div class="stat error">‚ùå <span id="errorCount">0</span> Erreurs</div>
                <div class="stat warning">‚è±Ô∏è <span id="totalTime">0</span>s Total</div>
            </div>
        </div>

        <button class="btn" onclick="testAllBooks()">üöÄ Tester TOUS les Livres</button>

        <div class="test-grid" id="testGrid"></div>
    </div>

    <script>
        const SEFARIA_API_BASE = 'https://www.sefaria.org/api';

        const BRESLOV_TEXTS = [
            {
                name: 'Likutei Moharan, Part I',
                ref: 'Likutei Moharan, Part I',
                testSection: 1
            },
            {
                name: 'Likutei Moharan, Part II',
                ref: 'Likutei Moharan, Part II',
                testSection: 1
            },
            {
                name: 'Sichot HaRan',
                ref: 'Sichot HaRan',
                testSection: 1
            },
            {
                name: 'Sefer HaMidot',
                ref: 'Sefer_HaMidot',
                testSection: 1
            },
            {
                name: "Rabbi Nachman's Stories",
                ref: "Rabbi Nachman's Stories",
                testSection: 1
            },
            {
                name: 'Likutei Etzot',
                ref: 'Likkutei_Etzot',
                testSection: 1
            },
            {
                name: 'Likutei Tefilot',
                ref: 'Likutei Tefilot',
                testSection: 1
            },
            {
                name: 'Chayei Moharan',
                ref: 'Chayei Moharan',
                testSection: 1
            }
        ];

        let successCount = 0;
        let errorCount = 0;
        let startTime;

        function createBookTestCard(book) {
            const card = document.createElement('div');
            card.className = 'book-test';
            card.id = `test-${book.ref.replace(/[^a-zA-Z0-9]/g, '_')}`;
            card.innerHTML = `
                <div class="book-name">${book.name}</div>
                <div class="status">‚è≥ En attente...</div>
                <div class="details" style="display: none;"></div>
            `;
            return card;
        }

        async function testBook(book, card) {
            const statusDiv = card.querySelector('.status');
            const detailsDiv = card.querySelector('.details');

            card.className = 'book-test testing';
            statusDiv.innerHTML = 'üîÑ Test en cours...';

            const fullRef = `${book.ref}.${book.testSection}`;
            const url = `${SEFARIA_API_BASE}/texts/${encodeURIComponent(fullRef)}?commentary=0&context=0&pad=0`;

            try {
                const testStart = Date.now();
                const response = await fetch(url);
                const testDuration = Date.now() - testStart;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                // V√©rifier les donn√©es
                const hasHebrew = data.he && (Array.isArray(data.he) ? data.he.length > 0 : data.he.length > 0);
                const hasEnglish = data.text && (Array.isArray(data.text) ? data.text.length > 0 : data.text.length > 0);

                if (!hasHebrew && !hasEnglish) {
                    throw new Error('Aucun contenu h√©breu ou anglais');
                }

                // Succ√®s
                card.className = 'book-test success';
                statusDiv.innerHTML = `‚úÖ Succ√®s (${testDuration}ms)`;
                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = `
                    <strong>Ref API:</strong> ${data.ref || fullRef}<br>
                    <strong>H√©breu:</strong> ${hasHebrew ? '‚úÖ' : '‚ùå'} ${Array.isArray(data.he) ? data.he.length : 1} versets<br>
                    <strong>Anglais:</strong> ${hasEnglish ? '‚úÖ' : '‚ùå'} ${Array.isArray(data.text) ? data.text.length : 1} versets<br>
                    <strong>URL:</strong> <a href="${url}" target="_blank">Tester API</a>
                `;
                successCount++;
                return { success: true, book: book.name };

            } catch (error) {
                card.className = 'book-test error';
                statusDiv.innerHTML = `‚ùå Erreur: ${error.message}`;
                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = `
                    <strong>Ref test√©:</strong> ${fullRef}<br>
                    <strong>Erreur:</strong> ${error.message}<br>
                    <strong>URL:</strong> <a href="${url}" target="_blank">D√©bugger</a><br>
                    <strong>Suggestions:</strong><br>
                    - V√©rifier le nom sur Sefaria.org<br>
                    - Tester avec/sans underscores<br>
                    - V√©rifier section/chapitre existe
                `;
                errorCount++;
                return { success: false, book: book.name, error: error.message };
            }
        }

        async function testAllBooks() {
            const testGrid = document.getElementById('testGrid');
            const summary = document.getElementById('summary');

            // Reset
            testGrid.innerHTML = '';
            successCount = 0;
            errorCount = 0;
            summary.style.display = 'none';
            startTime = Date.now();

            // Cr√©er les cartes
            const cards = BRESLOV_TEXTS.map(book => {
                const card = createBookTestCard(book);
                testGrid.appendChild(card);
                return { book, card };
            });

            // Tester s√©quentiellement (√©viter rate limiting)
            const results = [];
            for (const {book, card} of cards) {
                const result = await testBook(book, card);
                results.push(result);

                // Petite pause entre tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Afficher r√©sum√©
            const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
            summary.style.display = 'block';
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('errorCount').textContent = errorCount;
            document.getElementById('totalTime').textContent = totalTime;

            // Log console pour copier-coller
            console.log('=== R√âSULTATS DES TESTS ===');
            console.log(`Succ√®s: ${successCount}/${BRESLOV_TEXTS.length}`);
            console.log(`Erreurs: ${errorCount}/${BRESLOV_TEXTS.length}`);
            console.log('\nD√©tails:');
            results.forEach(r => {
                if (r.success) {
                    console.log(`‚úÖ ${r.book}`);
                } else {
                    console.log(`‚ùå ${r.book} - ${r.error}`);
                }
            });
        }

        // Auto-run au chargement
        window.addEventListener('load', () => {
            console.log('üîç Page de test pr√™te. Clique sur "Tester TOUS les Livres"');
        });
    </script>
</body>
</html>
